<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Lotus · Admin MVP</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">
<style>
  :root {
    --bg:#0b0b14; --card:#141428; --line:#2b2b44; --btn:#6c5cff; --btn2:#2a2a44;
  }
  body{font-family:system-ui;background:var(--bg);color:#fff;padding:20px;max-width:980px;margin:0 auto}
  h2{margin:0 0 8px}
  .muted{opacity:.75}
  .card{background:var(--card);padding:16px;border-radius:12px;margin-bottom:14px}
  input,select,button{padding:10px;border-radius:10px;border:none}
  input,select{min-width:240px}
  button{background:var(--btn);color:#fff;font-weight:750;cursor:pointer}
  button.secondary{background:var(--btn2)}
  button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  pre{white-space:pre-wrap;word-break:break-word;background:#0f0f1f;padding:10px;border-radius:10px;margin:10px 0 0}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#22223b;font-size:12px}
  .pill.ok{background:#1f3a2b}
  .pill.draft{background:#3a2a1f}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:13px;vertical-align:top}
  th{opacity:.85;font-weight:750}
  .small{font-size:12px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .headerRow{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .iconBtn{width:40px;min-width:40px;height:40px;padding:0;border-radius:12px;display:inline-flex;align-items:center;justify-content:center}
  .iconBtn.secondary{background:var(--btn2)}
  .iconBtn.danger{background:rgba(255,77,77,.15); color:#ffb0b0; border:1px solid rgba(255,77,77,.25)}
  .iconBtn.danger:hover{background:rgba(255,77,77,.22)}
  .sectionTitle{margin:0}

  .topBar{position:sticky;top:0;z-index:50;margin:-20px -20px 14px;padding:12px 20px;background:rgba(11,11,20,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .topBarInner{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .topBarLeft{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .topBarTitle{font-weight:850}
  .ctxLine{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .ctxKey{opacity:.75;font-size:12px}
  .ctxVal{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}
  .card.disabled{opacity:.55;filter:saturate(.75)}
  .card.disabled button, .card.disabled input, .card.disabled select{pointer-events:none}
  select{min-width:260px}
  .grow{flex:1 1 auto;min-width:240px}

  /* Modal */
  .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:100}
  .modalBackdrop.open{display:flex}
  .modal{background:var(--card);border:1px solid var(--line);border-radius:14px;max-width:720px;width:100%;padding:14px}
  .modalTop{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .modalClose{background:transparent;border:1px solid var(--line)}
</style>
</head>

<body>
<div class="topBar">
  <div class="topBarInner">
    <div class="topBarLeft">
      <div class="topBarTitle">Lotus · Admin</div>
      <div class="ctxLine">
        <span class="ctxKey">Релиз:</span>
        <span id="ctx-release" class="ctxVal">—</span>
        <span id="ctx-release-pill" class="pill draft">Черновик</span>
      </div>
      <div class="ctxLine">
        <span class="ctxKey">Сообщество:</span>
        <span id="ctx-community" class="ctxVal">—</span>
      </div>
    </div>
    <div class="topBarRight row" style="gap:8px">
      <button id="btn-publish-top" type="button" disabled>Опубликовать</button>
    </div>
  </div>
</div>

<h2>Админка · Интерактивный отчёт</h2>
<div class="muted" style="margin-bottom:12px">
  Backend: GitHub Pages → Yandex Function → GAS → Google Sheets
</div>

<!-- Modal: Create release -->
<div id="modal-backdrop" class="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modalTop">
      <h3 id="modal-title">Создать релиз</h3>
      <button id="btn-close-modal" class="iconBtn modalClose" type="button" title="Закрыть">✕</button>
    </div>

    <div class="row" style="margin-top:12px">
      <input id="r-title" placeholder="Название релиза" />
      <input id="r-password" placeholder="Пароль артиста" />
      <button id="btn-create-release" type="button">Создать</button>
      <button id="btn-cancel-create" class="secondary" type="button">Отмена</button>
    </div>
    <pre id="r-out">—</pre>
  </div>
</div>

<!-- Modal: Add community -->
<div id="modal-community-backdrop" class="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-community-title">
    <div class="modalTop">
      <h3 id="modal-community-title">Добавить сообщество</h3>
      <button id="btn-close-community-modal" class="iconBtn modalClose" type="button" title="Закрыть">✕</button>
    </div>

    <div class="muted small" style="margin-top:8px">
      Контекст: релиз <span class="mono" id="modal-community-release">—</span>. Введи ID сообщества. Название — опционально.
    </div>

    <div class="row" style="margin-top:12px">
      <input id="mc-id" placeholder="community_id (обязательно)" />
      <input id="mc-name" placeholder="community_name (опционально)" />
    </div>

    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button id="btn-community-cancel" class="secondary" type="button">Отмена</button>
      <button id="btn-community-save" type="button">Добавить</button>
    </div>
  </div>
</div>

<!-- A) Релизы -->
<div class="card">
  <div class="headerRow">
    <h3 class="sectionTitle">A) Релизы</h3>
    <button id="btn-refresh" class="iconBtn secondary" type="button" title="Обновить">↻</button>
  </div>
  <div class="row" style="margin-top:10px">
    <button id="btn-open-create" class="iconBtn" type="button" title="Создать релиз">＋</button>
    <!-- publish moved to top bar -->
  </div>

  <div class="row" style="margin-top:10px">
    <select id="release-select"></select>
  </div>

  <div style="margin-top:10px" id="selected-release"></div>
  <div class="muted small" id="global-status" style="margin-top:10px;opacity:.75">—</div>
</div>

<!-- B) Сообщества -->
<div class="card" id="card-communities">
  <div class="headerRow">
    <h3 class="sectionTitle">B) Сообщества VK для релиза</h3>
    <button id="btn-open-community" class="iconBtn" type="button" title="Добавить сообщество">＋</button>
  </div>

  <div class="row" style="margin-top:10px">
    <input id="community-release-id" placeholder="release_id (авто)" readonly />
    <select id="community-select" class="grow"></select>
    <span id="community-empty-hint" class="muted small" style="display:none">Сообщества не добавлены — нажми ＋</span>
  </div>

  <div id="community-list" style="margin-top:10px"></div>
</div>

<div class="card" id="card-campaigns">
  <div class="headerRow">
    <h3 class="sectionTitle">C) Кампании (VK)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteRaw('campaigns','out-campaigns')" title="Удалить прикреплённую таблицу">✕</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="file-campaigns" accept=".xlsx" />
    <button type="button" onclick="uploadVkKind('campaigns','file-campaigns','out-campaigns')">Загрузить</button>
  </div>
  <pre id="out-campaigns">—</pre>
</div>

<div class="card" id="card-groups">
  <div class="headerRow">
    <h3 class="sectionTitle">D) Группы (VK)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteRaw('groups','out-groups')" title="Удалить прикреплённую таблицу">✕</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="file-groups" accept=".xlsx" />
    <button type="button" onclick="uploadVkKind('groups','file-groups','out-groups')">Загрузить</button>
  </div>
  <pre id="out-groups">—</pre>
</div>

<div class="card" id="card-ads">
  <div class="headerRow">
    <h3 class="sectionTitle">E) Объявления (VK)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteRaw('ads','out-ads')" title="Удалить прикреплённую таблицу">✕</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="file-ads" accept=".xlsx" />
    <button type="button" onclick="uploadVkKind('ads','file-ads','out-ads')">Загрузить</button>
  </div>
  <pre id="out-ads">—</pre>
</div>

<div class="card" id="card-countries">
  <div class="headerRow">
    <h3 class="sectionTitle">F) Страны (VK)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteRaw('countries','out-countries')" title="Удалить прикреплённую таблицу">✕</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="file-countries" accept=".xlsx" />
    <button type="button" onclick="uploadVkKind('countries','file-countries','out-countries')">Загрузить</button>
  </div>
  <pre id="out-countries">—</pre>
</div>

<div class="card" id="card-cities">
  <div class="headerRow">
    <h3 class="sectionTitle">G) Города (VK)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteRaw('cities','out-cities')" title="Удалить прикреплённую таблицу">✕</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="file-cities" accept=".xlsx" />
    <button type="button" onclick="uploadVkKind('cities','file-cities','out-cities')">Загрузить</button>
  </div>
  <pre id="out-cities">—</pre>
</div>

<div class="card" id="card-demography">
  <div class="headerRow">
    <h3 class="sectionTitle">H) Демография (VK)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteRaw('demography','out-demography')" title="Удалить прикреплённую таблицу">✕</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="file-demography" accept=".xlsx" />
    <button type="button" onclick="uploadDemoGeoKind('demography','file-demography','out-demography')">Загрузить</button>
  </div>
  <pre id="out-demography">—</pre>
</div>

<div class="card" id="card-streams">
  <div class="headerRow">
    <h3 class="sectionTitle">I) Стримы (на весь релиз)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteStreams()" title="Удалить стримы">✕</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input id="streams-release-id" placeholder="release_id (авто)" readonly />
    <input type="file" id="streams-file" accept=".xlsx" />
    <button type="button" onclick="uploadStreams()">Загрузить</button>
  </div>
  <pre id="out-streams">—</pre>
</div>

<script>
/** ---------- Config ---------- */
const API_URL = "https://functions.yandexcloud.net/d4evbekf5us7hbjid3m3"; // TODO: replace

/** ---------- Helpers ---------- */
const $ = (id) => document.getElementById(id);
function esc_(s){ return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function setStatus(msg, isErr=false){
  const el = $('global-status');
  el.textContent = msg || '—';
  el.style.color = isErr ? '#ffb0b0' : '#b8ffd6';
}
function setOut(outId, obj){
  const el = $(outId);
  el.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
}
async function api(action, payload){
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action, ...payload })
  });
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || data.ok === false) throw new Error(data.error || 'API error');
  return data.data ?? data;
}

/** ---------- State ---------- */
const state = {
  releasesHeader: [],
  releasesRows: [],
  communitiesHeader: [],
  communitiesRows: [],
  selectedReleaseId: "",
  selectedCommunityId: ""
};

function idx_(header, name){ return header.indexOf(name); }
function getReleaseById_(id){
  const ridx = idx_(state.releasesHeader,'release_id');
  return state.releasesRows.find(r => String(r[ridx]) === String(id)) || null;
}
function getCommunitiesForRelease_(releaseId){
  if (!releaseId) return [];
  const h = state.communitiesHeader;
  const ridx = idx_(h,'release_id');
  const cid = idx_(h,'community_id');
  const cname = idx_(h,'community_name');
  const sidx = idx_(h,'sort_order');
  return state.communitiesRows
    .filter(r => String(r[ridx]) === String(releaseId))
    .map(r => ({
      release_id: r[ridx],
      community_id: String(r[cid] ?? ''),
      community_name: String(r[cname] ?? ''),
      sort_order: r[sidx]
    }))
    .sort((a,b)=> Number(a.sort_order||0) - Number(b.sort_order||0));
}

/** ---------- Modal: Create release ---------- */
function openCreateModal(){
  $('modal-backdrop').classList.add('open');
  $('modal-backdrop').setAttribute('aria-hidden','false');
  $('r-title').focus();
}
function closeCreateModal(){
  $('modal-backdrop').classList.remove('open');
  $('modal-backdrop').setAttribute('aria-hidden','true');
}
function clearCreateModal(){
  $('r-title').value = '';
  $('r-password').value = '';
  setOut('r-out','—');
}

function openCommunityModal_(){
  if (!state.selectedReleaseId) { setStatus('Сначала выбери релиз', true); return; }
  $('modal-community-release').textContent = state.selectedReleaseId;
  $('mc-id').value = '';
  $('mc-name').value = '';
  $('modal-community-backdrop').classList.add('open');
  $('modal-community-backdrop').setAttribute('aria-hidden','false');
  $('mc-id').focus();
}
function closeCommunityModal_(){
  $('modal-community-backdrop').classList.remove('open');
  $('modal-community-backdrop').setAttribute('aria-hidden','true');
}

/** ---------- Rendering ---------- */
function renderReleaseSelect(){
  const ridx = idx_(state.releasesHeader,'release_id');
  const titleIdx = idx_(state.releasesHeader,'title');
  const pubIdx = idx_(state.releasesHeader,'published');

  const opts = ['<option value="">Выбери релиз…</option>'].concat(
    state.releasesRows.map(r=>{
      const rid = r[ridx];
      const title = r[titleIdx];
      const publishedRaw = r[pubIdx];
      const published = (publishedRaw === true || String(publishedRaw).toLowerCase() === 'true');
      return `<option value="${esc_(rid)}">${esc_(title)} · ${esc_(rid)} ${published ? '✓' : ''}</option>`;
    })
  ).join('');
  $('release-select').innerHTML = opts;
  $('release-select').value = state.selectedReleaseId || "";
}

function renderSelectedRelease(){
  const rel = state.selectedReleaseId ? getReleaseById_(state.selectedReleaseId) : null;
  if (!rel){
    $('selected-release').innerHTML = `<div class="muted">Релиз не выбран</div>`;
    $('community-release-id').value = "";
    $('streams-release-id').value = "";
    $('community-list').innerHTML = '';
    $('btn-publish-top').disabled = true;
    renderContext_();
    return;
  }

  const h = state.releasesHeader;
  const title = rel[idx_(h,'title')];
  const slug = rel[idx_(h,'login_slug')];
  const publishedRaw = rel[idx_(h,'published')];
  const published = (publishedRaw === true || String(publishedRaw).toLowerCase() === 'true');
  const rid = rel[idx_(h,'release_id')];
  const pass = rel[idx_(h,'password')];
  const ps = rel[idx_(h,'period_start')];
  const pe = rel[idx_(h,'period_end')];

  $('community-release-id').value = rid;
  $('streams-release-id').value = rid;

  $('selected-release').innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div>
        <div><b>${esc_(title)}</b></div>
        <div class="small muted">
          <span class="mono">${esc_(rid)}</span>
          · slug: <span class="mono">${esc_(slug)}</span>
          · пароль: <span class="mono">${esc_(pass)}</span>
        </div>
        <div class="small muted">${esc_(ps)} — ${esc_(pe)}</div>
      </div>
      <div><span class="pill ${published ? 'ok' : 'draft'}">${published ? 'Опубликовано' : 'Черновик'}</span></div>
    </div>
  `;

  $('btn-publish-top').textContent = published ? 'Снять с публикации' : 'Опубликовать';
  $('btn-publish-top').disabled = false;

  renderCommunityList();
  renderContext_();
}

function renderContext_(){
  const rel = state.selectedReleaseId ? getReleaseById_(state.selectedReleaseId) : null;
  const relId = state.selectedReleaseId || "";
  const comId = state.selectedCommunityId || "";

  $('ctx-release').textContent = relId ? relId : '—';
  $('ctx-community').textContent = comId ? comId : '—';

  if (!rel){
    $('ctx-release-pill').textContent = '—';
    $('ctx-release-pill').className = 'pill draft';
  }else{
    const h = state.releasesHeader;
    const publishedRaw = rel[idx_(h,'published')];
    const published = (publishedRaw === true || String(publishedRaw).toLowerCase() === 'true');
    $('ctx-release-pill').textContent = published ? 'Опубликовано' : 'Черновик';
    $('ctx-release-pill').className = 'pill ' + (published ? 'ok' : 'draft');
  }

  const hasRelease = !!relId;
  const hasCommunity = !!comId;

  $('card-communities').classList.toggle('disabled', !hasRelease);

  const vkIds = ['card-campaigns','card-groups','card-ads','card-countries','card-cities','card-demography'];
  vkIds.forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.classList.toggle('disabled', !(hasRelease && hasCommunity));
  });

  const streams = document.getElementById('card-streams');
  if (streams) streams.classList.toggle('disabled', !hasRelease);
}

function renderCommunityList(){
  const relId = state.selectedReleaseId;
  const list = getCommunitiesForRelease_(relId);

  if (!relId){
    $('community-list').innerHTML = `<div class="muted small">Сначала выбери релиз</div>`;
    $('community-empty-hint').style.display = 'none';
    $('community-select').innerHTML = '';
    state.selectedCommunityId = '';
    renderContext_();
    return;
  }

  if (!list.length){
    $('community-list').innerHTML = `<div class="muted small">Сообщества не добавлены</div>`;
    $('community-empty-hint').style.display = '';
    $('community-select').innerHTML = `<option value="">—</option>`;
    state.selectedCommunityId = '';
    renderContext_();
    return;
  }

  $('community-empty-hint').style.display = 'none';

  const opts = ['<option value="">Выбери сообщество…</option>'].concat(
    list.map(c => `<option value="${esc_(c.community_id)}">${esc_(c.community_name || c.community_id)} · ${esc_(c.community_id)}</option>`)
  ).join('');
  $('community-select').innerHTML = opts;

  const exists = list.some(c => c.community_id === state.selectedCommunityId);
  if (!exists) state.selectedCommunityId = list[0].community_id;
  $('community-select').value = state.selectedCommunityId;

  const rows = list.map(c=>`
    <tr>
      <td class="mono">${esc_(c.community_id)}</td>
      <td>${esc_(c.community_name || '')}</td>
      <td class="small muted">${esc_(c.sort_order)}</td>
    </tr>
  `).join('');

  $('community-list').innerHTML = `
    <table>
      <thead><tr>
        <th>community_id</th><th>Название</th><th>sort</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;

  renderContext_();
}

function onSelectCommunity(){
  state.selectedCommunityId = $('community-select').value || "";
  renderContext_();
}

/** ---------- Data load ---------- */
async function refresh(){
  $('btn-refresh').disabled = true;
  try{
    const data = await api('bootstrapAdmin', {});
    state.releasesHeader = data.releasesHeader || [];
    state.releasesRows = data.releases || [];
    state.communitiesHeader = data.communitiesHeader || [];
    state.communitiesRows = data.communities || [];

    renderReleaseSelect();
    renderSelectedRelease();
    setStatus('Данные обновлены');
  }catch(e){
    setStatus('Ошибка обновления: ' + e.message, true);
  }finally{
    $('btn-refresh').disabled = false;
  }
}

function onSelectRelease(){
  state.selectedReleaseId = $('release-select').value || "";
  state.selectedCommunityId = "";
  renderSelectedRelease();
}

async function addCommunity(){
  try{
    const release_id = state.selectedReleaseId || "";
    if (!release_id) throw new Error('Сначала выбери релиз');

    const community_id = $('mc-id') ? $('mc-id').value.trim() : '';
    const community_name = $('mc-name') ? $('mc-name').value.trim() : '';
    if (!community_id) throw new Error('Укажи community_id');

    const existing = getCommunitiesForRelease_(release_id).some(c => c.community_id === community_id);
    if (existing) throw new Error('Такое сообщество уже добавлено');

    await api('addCommunity', { release_id, community_id, community_name });
    setStatus('Сообщество добавлено');
    closeCommunityModal_();

    await refresh();
    state.selectedReleaseId = release_id;
    state.selectedCommunityId = community_id;
    renderSelectedRelease();
  }catch(e){
    setStatus('Ошибка: ' + e.message, true);
  }
}

async function togglePublish(){
  try{
    const release_id = state.selectedReleaseId || "";
    if (!release_id) throw new Error('Сначала выбери релиз');
    $('btn-publish-top').disabled = true;
    await api('togglePublish', { release_id });
    await refresh();
    setStatus('Статус публикации обновлён');
  }catch(e){
    setStatus('Ошибка: ' + e.message, true);
  }finally{
    $('btn-publish-top').disabled = false;
  }
}

/** ---------- Upload context ---------- */
function getCtx_(){
  const release_id = state.selectedReleaseId || "";
  const community_id = state.selectedCommunityId || "";
  if (!release_id) throw new Error('Нет release_id (выбери релиз)');
  if (!community_id) throw new Error('Не выбрано сообщество (добавь/выбери в блоке B)');
  return { release_id, community_id };
}

/** ---------- XLSX minimal reader (placeholder) ---------- */
/* В твоей исходной версии здесь уже есть readExcelFirstSheet(). Оставляю вызовы как есть. */
async function readExcelFirstSheet(file){
  throw new Error('readExcelFirstSheet() не найден в этом фрагменте. Вставь свою реализацию из исходника.');
}

/** ---------- Uploads ---------- */
async function uploadVkKind(kind, fileInputId, outId){
  try{
    const { release_id, community_id } = getCtx_();
    const file = $(fileInputId).files[0];
    if (!file) throw new Error('Файл не выбран');

    const rows = await readExcelFirstSheet(file);
    const header = rows.shift();
    const dataRows = rows.filter(r => r && r.length && r.some(v => String(v ?? '').trim() !== ''));

    const resp = await api('uploadVkTable', { kind, release_id, community_id, header, rows: dataRows });
    setOut(outId, resp);
    setStatus(`Загружено: ${kind} · ${resp.added ?? 0} строк`);
  }catch(e){
    setOut(outId, 'Ошибка: ' + e.message);
    setStatus('Ошибка: ' + e.message, true);
  }
}

async function uploadDemoGeoKind(kind, fileInputId, outId){
  try{
    const { release_id, community_id } = getCtx_();
    const file = $(fileInputId).files[0];
    if (!file) throw new Error('Файл не выбран');

    const rows = await readExcelFirstSheet(file);
    const header = rows.shift();
    const dataRows = rows.filter(r => r && r.length && r.some(v => String(v ?? '').trim() !== ''));

    const resp = await api('uploadDemoGeoTable', { kind, release_id, community_id, header, rows: dataRows });
    setOut(outId, resp);
    setStatus(`Загружено: ${kind} · ${resp.added ?? 0} строк`);
  }catch(e){
    setOut(outId, 'Ошибка: ' + e.message);
    setStatus('Ошибка: ' + e.message, true);
  }
}

async function deleteRaw(kind, outId){
  try{
    const { release_id, community_id } = getCtx_();
    const resp = await api('deleteVkTable', { kind, release_id, community_id });
    setOut(outId, resp);
    setStatus(`Удалено: ${kind}`);
  }catch(e){
    setOut(outId, 'Ошибка: ' + e.message);
    setStatus('Ошибка: ' + e.message, true);
  }
}

/** ---------- Streams ---------- */
async function uploadStreams(){
  try{
    const release_id = $('streams-release-id').value.trim();
    if (!release_id) throw new Error('Нет release_id (выбери релиз)');
    const file = $('streams-file').files[0];
    if (!file) throw new Error('Файл не выбран');

    const rows = await readExcelFirstSheet(file);
    const header = rows.shift();
    const dataRows = rows.filter(r => r && r.length && r.some(v => String(v ?? '').trim() !== ''));

    const resp = await api('uploadStreams', { release_id, header, rows: dataRows });
    setOut('out-streams', resp);
    setStatus(`Загружено: стримы · ${resp.added ?? 0} строк`);
  }catch(e){
    setOut('out-streams', 'Ошибка: ' + e.message);
    setStatus('Ошибка: ' + e.message, true);
  }
}

async function deleteStreams(){
  try{
    const release_id = $('streams-release-id').value.trim();
    if (!release_id) throw new Error('Нет release_id (выбери релиз)');
    const resp = await api('deleteStreams', { release_id });
    setOut('out-streams', resp);
    setStatus('Стримы удалены');
  }catch(e){
    setOut('out-streams', 'Ошибка: ' + e.message);
    setStatus('Ошибка: ' + e.message, true);
  }
}

/** ---------- Create release ---------- */
async function createRelease(){
  try{
    const title = $('r-title').value.trim();
    const password = $('r-password').value.trim();
    if (!title || !password) throw new Error('Укажи название и пароль');

    const resp = await api('createRelease', { title, password });
    setOut('r-out', resp);
    setStatus('Релиз создан');
    closeCreateModal();
    await refresh();
  }catch(e){
    setOut('r-out', 'Ошибка: ' + e.message);
    setStatus('Ошибка: ' + e.message, true);
  }
}

/** ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  $('btn-refresh').addEventListener('click', refresh);
  $('release-select').addEventListener('change', onSelectRelease);
  $('btn-publish-top').addEventListener('click', togglePublish);

  // Modal bindings
  $('btn-open-create').addEventListener('click', () => { clearCreateModal(); openCreateModal(); });
  $('btn-close-modal').addEventListener('click', closeCreateModal);
  $('btn-cancel-create').addEventListener('click', closeCreateModal);
  $('modal-backdrop').addEventListener('click', (e) => { if (e.target === $('modal-backdrop')) closeCreateModal(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeCreateModal(); closeCommunityModal_(); } });

  // Communities bindings
  $('community-select').addEventListener('change', onSelectCommunity);
  $('btn-open-community').addEventListener('click', openCommunityModal_);
  $('btn-close-community-modal').addEventListener('click', closeCommunityModal_);
  $('btn-community-cancel').addEventListener('click', closeCommunityModal_);
  $('btn-community-save').addEventListener('click', addCommunity);
  $('modal-community-backdrop').addEventListener('click', (e) => { if (e.target === $('modal-community-backdrop')) closeCommunityModal_(); });

  $('btn-create-release').addEventListener('click', createRelease);

  await refresh();
  renderContext_();
});
</script>
</body>
</html>
