<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Lotus ¬∑ Admin MVP</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">
<style>
  :root {
    --bg:#0b0b14; --card:#141428; --line:#2b2b44; --btn:#6c5cff; --btn2:#2a2a44;
  }
  body{font-family:system-ui;background:var(--bg);color:#fff;padding:20px;max-width:980px;margin:0 auto}
  h2{margin:0 0 8px}
  .muted{opacity:.75}
  .card{background:var(--card);padding:16px;border-radius:12px;margin-bottom:14px}
  input,select,button{padding:10px;border-radius:10px;border:none}
  input,select{min-width:240px}
  button{background:var(--btn);color:#fff;font-weight:750;cursor:pointer}
  button.secondary{background:var(--btn2)}
  button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  pre{white-space:pre-wrap;word-break:break-word;background:#0f0f1f;padding:10px;border-radius:10px;margin:10px 0 0}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#22223b;font-size:12px}
  .pill.ok{background:#1f3a2b}
  .pill.draft{background:#3a2a1f}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:13px;vertical-align:top}
  th{opacity:.85;font-weight:750}
  .small{font-size:12px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .headerRow{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .iconBtn{width:40px;min-width:40px;height:40px;padding:0;border-radius:12px;display:inline-flex;align-items:center;justify-content:center}
  .iconBtn.secondary{background:var(--btn2)}
  .iconBtn.danger{background:rgba(255,77,77,.15); color:#ffb0b0; border:1px solid rgba(255,77,77,.25)}
  .iconBtn.danger:hover{background:rgba(255,77,77,.22)}
  .sectionTitle{margin:0}

  /* Modal */
  .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
  .modalBackdrop.open{display:flex}
  .modal{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;max-width:720px;width:100%;padding:16px}
  .modalTop{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .modalTop h3{margin:0}
  .modalClose{background:transparent;border:1px solid rgba(255,255,255,.12);color:#fff}
  .modalClose:hover{border-color:rgba(255,255,255,.22)}
</style>
</head>
<body>

<h2>Lotus ¬∑ Admin MVP</h2>
<div class="muted" style="margin-bottom:12px">
  Backend: GitHub Pages ‚Üí Yandex Function ‚Üí GAS ‚Üí Google Sheets
</div>

<!-- Modal: Create release -->
<div id="modal-backdrop" class="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modalTop">
      <h3 id="modal-title">–°–æ–∑–¥–∞—Ç—å —Ä–µ–ª–∏–∑</h3>
      <button id="btn-close-modal" class="iconBtn modalClose" type="button" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </div>

    <div class="row" style="margin-top:12px">
      <input id="r-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞" />
      <input id="r-password" placeholder="–ü–∞—Ä–æ–ª—å –∞—Ä—Ç–∏—Å—Ç–∞" />
      <button id="btn-create-release" type="button">–°–æ–∑–¥–∞—Ç—å</button>
      <button id="btn-cancel-create" class="secondary" type="button">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <pre id="r-out">‚Äî</pre>

    <div class="muted small" style="margin-top:8px">
      –õ–æ–≥–∏–Ω (slug) –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü–æ–∫–∞ —Ä–µ–ª–∏–∑ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω, –∞—Ä—Ç–∏—Å—Ç –µ–≥–æ –Ω–µ —É–≤–∏–¥–∏—Ç.
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
/** ===============================
 *  CONFIG
 *  =============================== */
const API_URL = "https://functions.yandexcloud.net/d4evbekf5us7hbjid3m3";

/** ---------- Utilities ---------- */
const $ = (id) => document.getElementById(id);
function esc_(s){ return String(s ?? '').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function setOut(id, obj){ $(id).textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2); }

async function api(action, data){
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ action, data })
  });
  const json = await res.json().catch(()=>null);
  if (!json) throw new Error('–û—Ç–≤–µ—Ç –Ω–µ JSON (–ø—Ä–æ–≤–µ—Ä—å Yandex Function)');
  if (!json.ok) throw new Error(json.error || 'Unknown API error');
  return json.data;
}

function readExcelFirstSheet(file){
  return new Promise((resolve, reject) => {
    if (!file) return reject(new Error('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'));
    const r = new FileReader();
    r.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type:'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });
        resolve(rows);
      } catch (err){ reject(err); }
    };
    r.onerror = reject;
    r.readAsBinaryString(file);
  });
}

function setStatus(text, isErr=false){
  const el = $('global-status');
  el.textContent = text;
  el.style.opacity = "1";
  el.style.color = isErr ? "#ff9d9d" : "#b9ffcf";
  setTimeout(()=>{ el.style.opacity="0.75"; }, 1600);
}

/** ---------- State ---------- */
const state = {
  releasesHeader: [],
  releasesRows: [],
  communitiesHeader: [],
  communitiesRows: [],
  selectedReleaseId: ""
};

function idx_(header, name){ return header.indexOf(name); }
function getReleaseById_(id){
  const ridx = idx_(state.releasesHeader,'release_id');
  return state.releasesRows.find(r => String(r[ridx]) === String(id)) || null;
}
function getCommunitiesForRelease_(release_id){
  const ridx = idx_(state.communitiesHeader,'release_id');
  const cid = idx_(state.communitiesHeader,'community_id');
  const cname = idx_(state.communitiesHeader,'community_name');
  const sidx = idx_(state.communitiesHeader,'sort_order');
  return state.communitiesRows
    .filter(r => String(r[ridx]) === String(release_id))
    .map(r => ({
      community_id: String(r[cid] ?? ''),
      community_name: String(r[cname] ?? ''),
      sort_order: Number(r[sidx] ?? 0)
    }))
    .sort((a,b)=>a.sort_order-b.sort_order);
}

/** ---------- Modal control ---------- */
function openCreateModal(){
  $('modal-backdrop').classList.add('open');
  $('modal-backdrop').setAttribute('aria-hidden','false');
  $('r-title').focus();
}
function closeCreateModal(){
  $('modal-backdrop').classList.remove('open');
  $('modal-backdrop').setAttribute('aria-hidden','true');
}
function clearCreateModal(){
  $('r-title').value = '';
  $('r-password').value = '';
  setOut('r-out','‚Äî');
}

/** ---------- Rendering ---------- */
function renderReleaseSelect(){
  const ridx = idx_(state.releasesHeader,'release_id');
  const titleIdx = idx_(state.releasesHeader,'title');
  const pubIdx = idx_(state.releasesHeader,'published');
  const slugIdx = idx_(state.releasesHeader,'login_slug');

  const options = state.releasesRows.map(r=>{
    const id = String(r[ridx] ?? '');
    const title = String(r[titleIdx] ?? '');
    const slug = String(r[slugIdx] ?? '');
    const pub = (r[pubIdx] === true || String(r[pubIdx]).toLowerCase() === 'true');
    const mark = pub ? 'üü¢' : 'üü°';
    return `<option value="${esc_(id)}">${mark} ${esc_(title)} (${esc_(slug)})</option>`;
  }).join('');

  $('release-select').innerHTML = `<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å —Ä–µ–ª–∏–∑ ‚Äî</option>` + options;
  $('release-select').value = state.selectedReleaseId || "";
}

function renderSelectedRelease(){
  const rel = state.selectedReleaseId ? getReleaseById_(state.selectedReleaseId) : null;
  if (!rel){
    $('selected-release').innerHTML = `<div class="muted">–†–µ–ª–∏–∑ –Ω–µ –≤—ã–±—Ä–∞–Ω</div>`;
    $('community-release-id').value = "";
    $('streams-release-id').value = "";
    $('upload-release-id').value = "";
    $('community-list').innerHTML = '';
    $('btn-publish').disabled = true;
    return;
  }

  const h = state.releasesHeader;
  const title = rel[idx_(h,'title')];
  const slug = rel[idx_(h,'login_slug')];
  const publishedRaw = rel[idx_(h,'published')];
  const published = (publishedRaw === true || String(publishedRaw).toLowerCase() === 'true');
  const rid = rel[idx_(h,'release_id')];
  const pass = rel[idx_(h,'password')];
  const ps = rel[idx_(h,'period_start')];
  const pe = rel[idx_(h,'period_end')];

  $('community-release-id').value = rid;
  $('streams-release-id').value = rid;
  $('upload-release-id').value = rid;

  $('selected-release').innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div>
        <div><b>${esc_(title)}</b></div>
        <div class="small muted">
          <span class="mono">${esc_(rid)}</span>
          ¬∑ slug: <span class="mono">${esc_(slug)}</span>
          ¬∑ –ø–∞—Ä–æ–ª—å: <span class="mono">${esc_(pass)}</span>
        </div>
        <div class="small muted">${esc_(ps)} ‚Äî ${esc_(pe)}</div>
      </div>
      <div><span class="pill ${published ? 'ok' : 'draft'}">${published ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫'}</span></div>
    </div>
  `;

  $('btn-publish').textContent = published ? '–°–Ω—è—Ç—å —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏' : '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
  $('btn-publish').disabled = false;

  renderCommunityList();
}

function renderCommunityList(){
  const relId = state.selectedReleaseId;
  const list = getCommunitiesForRelease_(relId);
  if (!list.length){
    $('community-list').innerHTML = `<div class="muted small">–°–æ–æ–±—â–µ—Å—Ç–≤–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>`;
    return;
  }
  const rows = list.map(c=>`
    <tr>
      <td class="mono">${esc_(c.community_id)}</td>
      <td>${esc_(c.community_name)}</td>
      <td class="small muted">${esc_(c.sort_order)}</td>
      <td>
        <button class="secondary" type="button" onclick="selectCommunity('${esc_(c.community_id)}')">–í—ã–±—Ä–∞—Ç—å</button>
      </td>
    </tr>
  `).join('');

  $('community-list').innerHTML = `
    <table>
      <thead><tr>
        <th>community_id</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>sort</th><th>–î–ª—è –∑–∞–≥—Ä—É–∑–æ–∫</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function selectCommunity(cid){
  $('community-id').value = cid;
  setStatus('–í—ã–±—Ä–∞–Ω–æ community_id: ' + cid);
}

/** ---------- Data load ---------- */
async function refresh(){
  $('btn-refresh').disabled = true;
  try{
    const data = await api('bootstrapAdmin', {});
    state.releasesHeader = data.releasesHeader || [];
    state.releasesRows = data.releases || [];
    state.communitiesHeader = data.communitiesHeader || [];
    state.communitiesRows = data.communities || [];

    renderReleaseSelect();
    renderSelectedRelease();
    setStatus('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
  }catch(e){
    setStatus('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + e.message, true);
  }finally{
    $('btn-refresh').disabled = false;
  }
}

/** ---------- Actions ---------- */
async function createRelease(){
  try{
    const title = $('r-title').value.trim();
    const password = $('r-password').value.trim();
    if (!title) throw new Error('–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞');
    if (!password) throw new Error('–£–∫–∞–∂–∏ –ø–∞—Ä–æ–ª—å –∞—Ä—Ç–∏—Å—Ç–∞');

    const data = await api('createRelease', { title, password });
    setOut('r-out', data);

    await refresh();
    state.selectedReleaseId = data.release_id;
    renderReleaseSelect();
    renderSelectedRelease();
    setStatus('–†–µ–ª–∏–∑ —Å–æ–∑–¥–∞–Ω');
  }catch(e){
    setOut('r-out', '–û—à–∏–±–∫–∞: ' + e.message);
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

async function onSelectRelease(){
  state.selectedReleaseId = $('release-select').value || "";
  renderSelectedRelease();
}

async function addCommunity(){
  try{
    const release_id = $('community-release-id').value.trim();
    if (!release_id) throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑');

    const community_id = $('c-id').value.trim();
    const community_name = $('c-name').value.trim();
    if (!community_id || !community_name) throw new Error('–£–∫–∞–∂–∏ community_id –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ');

    const existing = getCommunitiesForRelease_(release_id).some(c => c.community_id === community_id);
    if (existing) throw new Error('–¢–∞–∫–æ–π community_id —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –∫ —Ä–µ–ª–∏–∑—É');

    await api('addCommunity', { release_id, community_id, community_name, sort_order: getCommunitiesForRelease_(release_id).length + 1 });

    $('c-id').value = '';
    $('c-name').value = '';

    await refresh();
    state.selectedReleaseId = release_id;
    renderSelectedRelease();
    setStatus('–°–æ–æ–±—â–µ—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
  }catch(e){
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

async function togglePublish(){
  try{
    const release_id = state.selectedReleaseId;
    if (!release_id) throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑');

    const rel = getReleaseById_(release_id);
    const publishedRaw = rel[idx_(state.releasesHeader,'published')];
    const published = (publishedRaw === true || String(publishedRaw).toLowerCase() === 'true');

    await api('publishRelease', { release_id, published: !published });

    await refresh();
    state.selectedReleaseId = release_id;
    renderSelectedRelease();
    setStatus(!published ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ' : '–°–Ω—è—Ç–æ —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏');
  }catch(e){
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

/** ---------- Upload / Delete ---------- */
function getCtx_(){
  const release_id = $('upload-release-id').value.trim();
  const community_id = $('community-id').value.trim();
  if (!release_id) throw new Error('–ù–µ—Ç release_id (–≤—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑)');
  if (!community_id) throw new Error('–ù–µ –≤—ã–±—Ä–∞–Ω community_id (–≤—ã–±–µ—Ä–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —Å–æ–æ–±—â–µ—Å—Ç–≤)');
  return { release_id, community_id };
}

async function uploadVkKind(kind, fileInputId, outId){
  try{
    const { release_id, community_id } = getCtx_();
    const file = $(fileInputId).files[0];
    if (!file) throw new Error('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');

    const rows = await readExcelFirstSheet(file);
    const header = rows.shift();
    const dataRows = rows.filter(r => r && r.length && r.some(v => String(v ?? '').trim() !== ''));

    const resp = await api('uploadVkTable', { kind, release_id, community_id, header, rows: dataRows });
    setOut(outId, resp);
    setStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${kind} ¬∑ ${resp.added ?? 0} —Å—Ç—Ä–æ–∫`);
  }catch(e){
    setOut(outId, '–û—à–∏–±–∫–∞: ' + e.message);
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

async function uploadDemoGeoKind(kind, fileInputId, outId){
  try{
    const { release_id, community_id } = getCtx_();
    const file = $(fileInputId).files[0];
    if (!file) throw new Error('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');

    const all = await readExcelFirstSheet(file);
    const meta = all.slice(0,5);
    const header = all[5];
    const rows = all.slice(6).filter(r => r && r.length && r.some(v => String(v ?? '').trim() !== ''));

    const campaign_id = String((meta[0] && meta[0][1]) || '').trim();
    const campaign_name = String((meta[1] && meta[1][1]) || '').trim();
    const period_from = String((meta[3] && meta[3][1]) || '').trim();
    const period_to = String((meta[4] && meta[4][1]) || '').trim();

    const resp = await api('uploadDemoGeoTable', {
      kind, release_id, community_id,
      campaign_id, campaign_name, period_from, period_to,
      header, rows
    });

    setOut(outId, resp);
    setStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${kind} ¬∑ ${resp.added ?? 0} —Å—Ç—Ä–æ–∫`);
  }catch(e){
    setOut(outId, '–û—à–∏–±–∫–∞: ' + e.message);
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

async function deleteRaw(kind, outId){
  try{
    const { release_id, community_id } = getCtx_();
    const resp = await api('deleteRawTable', { kind, release_id, community_id });
    setOut(outId, resp);
    setStatus(`–£–¥–∞–ª–µ–Ω–æ: ${kind} ¬∑ ${resp.deleted ?? 0} —Å—Ç—Ä–æ–∫`);
  }catch(e){
    setOut(outId, '–û—à–∏–±–∫–∞: ' + e.message);
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

async function uploadStreams(){
  try{
    const release_id = $('streams-release-id').value.trim();
    if (!release_id) throw new Error('–ù–µ—Ç release_id (–≤—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑)');
    const file = $('streams-file').files[0];
    if (!file) throw new Error('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');

    const rows = await readExcelFirstSheet(file);
    const first = rows[0] || [];
    const looksHeader = String(first[0] || '').toLowerCase().includes('–¥–∞—Ç–∞') || String(first[0] || '').toLowerCase().includes('date');
    if (looksHeader) rows.shift();

    const header = ["date","streams_ok","streams_vk","streams_yandex"];
    const dataRows = rows
      .filter(r => r && r.length && r.some(v => String(v ?? '').trim() !== ''))
      .map(r => [r[0] ?? '', r[1] ?? '', r[2] ?? '', r[3] ?? '']);

    const resp = await api('uploadStreams', { release_id, header, rows: dataRows });
    setOut('streams-out', resp);
    setStatus(`–°—Ç—Ä–∏–º—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã ¬∑ ${resp.added ?? 0} —Å—Ç—Ä–æ–∫`);
  }catch(e){
    setOut('streams-out', '–û—à–∏–±–∫–∞: ' + e.message);
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

async function deleteStreams(){
  try{
    const release_id = $('streams-release-id').value.trim();
    if (!release_id) throw new Error('–ù–µ—Ç release_id (–≤—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑)');
    const resp = await api('deleteStreams', { release_id });
    setOut('streams-out', resp);
    setStatus(`–°—Ç—Ä–∏–º—ã —É–¥–∞–ª–µ–Ω—ã ¬∑ ${resp.deleted ?? 0} —Å—Ç—Ä–æ–∫`);
  }catch(e){
    setOut('streams-out', '–û—à–∏–±–∫–∞: ' + e.message);
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}
</script>

<!-- A) –†–µ–ª–∏–∑—ã -->
<div class="card">
  <div class="headerRow">
    <div class="row">
      <h3 class="sectionTitle">A) –†–µ–ª–∏–∑—ã</h3>
      <button id="btn-refresh" class="iconBtn secondary" type="button" title="–û–±–Ω–æ–≤–∏—Ç—å">‚Üª</button>
    </div>
    <div class="row">
      <button id="btn-open-create" class="iconBtn" type="button" title="–°–æ–∑–¥–∞—Ç—å —Ä–µ–ª–∏–∑">Ôºã</button>
      <button id="btn-publish" type="button" disabled>–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <select id="release-select"></select>
  </div>

  <div style="margin-top:10px" id="selected-release"></div>
  <div class="muted small" id="global-status" style="margin-top:10px;opacity:.75">‚Äî</div>
</div>

<!-- B) –°–æ–æ–±—â–µ—Å—Ç–≤–∞ -->
<div class="card">
  <h3 class="sectionTitle">B) –°–æ–æ–±—â–µ—Å—Ç–≤–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–ª–∏–∑–∞</h3>
  <div class="row" style="margin-top:10px">
    <input id="community-release-id" placeholder="release_id (–∞–≤—Ç–æ)" readonly />
    <input id="c-id" placeholder="community_id" />
    <input id="c-name" placeholder="community_name" />
    <button id="btn-add-community" type="button">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
  <div id="community-list"></div>

  <div class="row" style="margin-top:10px">
    <input id="upload-release-id" placeholder="release_id (–∞–≤—Ç–æ)" readonly />
    <input id="community-id" placeholder="community_id (–≤—ã–±—Ä–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ)" />
    <span class="muted small">–î–ª—è –∑–∞–≥—Ä—É–∑–æ–∫/—É–¥–∞–ª–µ–Ω–∏–π –≤—ã–±–µ—Ä–∏ community_id –∫–Ω–æ–ø–∫–æ–π ¬´–í—ã–±—Ä–∞—Ç—å¬ª.</span>
  </div>
</div>

<div class="card">
  <div class="headerRow">
    <h3 class="sectionTitle">C) –ö–∞–º–ø–∞–Ω–∏–∏ (VK)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteRaw('campaigns','out-campaigns')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É">‚úï</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="file-campaigns" accept=".xlsx" />
    <button type="button" onclick="uploadVkKind('campaigns','file-campaigns','out-campaigns')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>
  <pre id="out-campaigns">‚Äî</pre>
</div>

<div class="card">
  <div class="headerRow">
    <h3 class="sectionTitle">D) –ì—Ä—É–ø–ø—ã (VK)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteRaw('groups','out-groups')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É">‚úï</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="file-groups" accept=".xlsx" />
    <button type="button" onclick="uploadVkKind('groups','file-groups','out-groups')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>
  <pre id="out-groups">‚Äî</pre>
</div>

<div class="card">
  <div class="headerRow">
    <h3 class="sectionTitle">E) –û–±—ä—è–≤–ª–µ–Ω–∏—è (VK)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteRaw('ads','out-ads')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É">‚úï</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="file-ads" accept=".xlsx" />
    <button type="button" onclick="uploadVkKind('ads','file-ads','out-ads')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>
  <pre id="out-ads">‚Äî</pre>
</div>

<div class="card">
  <div class="headerRow">
    <h3 class="sectionTitle">F) –î–µ–º–æ–≥—Ä–∞—Ñ–∏—è (VK)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteRaw('demo','out-demo')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É">‚úï</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="file-demo" accept=".xlsx" />
    <button type="button" onclick="uploadDemoGeoKind('demo','file-demo','out-demo')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>
  <pre id="out-demo">‚Äî</pre>
</div>

<div class="card">
  <div class="headerRow">
    <h3 class="sectionTitle">G) –°—Ç—Ä–∞–Ω—ã (VK)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteRaw('countries','out-countries')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É">‚úï</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="file-countries" accept=".xlsx" />
    <button type="button" onclick="uploadDemoGeoKind('countries','file-countries','out-countries')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>
  <pre id="out-countries">‚Äî</pre>
</div>

<div class="card">
  <div class="headerRow">
    <h3 class="sectionTitle">H) –ì–æ—Ä–æ–¥–∞ (VK)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteRaw('cities','out-cities')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É">‚úï</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="file-cities" accept=".xlsx" />
    <button type="button" onclick="uploadDemoGeoKind('cities','file-cities','out-cities')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>
  <pre id="out-cities">‚Äî</pre>
</div>

<div class="card">
  <div class="headerRow">
    <h3 class="sectionTitle">I) –°—Ç—Ä–∏–º—ã (–Ω–∞ –≤–µ—Å—å —Ä–µ–ª–∏–∑)</h3>
    <button class="iconBtn danger" type="button" onclick="deleteStreams()" title="–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∏–º—ã">‚úï</button>
  </div>
  <div class="row" style="margin-top:10px">
    <input id="streams-release-id" placeholder="release_id (–∞–≤—Ç–æ)" readonly />
    <input type="file" id="streams-file" accept=".xlsx" />
    <button type="button" onclick="uploadStreams()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>
  <pre id="streams-out">‚Äî</pre>
</div>

<script>
  // Bind UI
  $('btn-refresh').addEventListener('click', refresh);
  $('release-select').addEventListener('change', onSelectRelease);
  $('btn-add-community').addEventListener('click', addCommunity);
  $('btn-publish').addEventListener('click', togglePublish);

  // Modal bindings
  $('btn-open-create').addEventListener('click', () => { clearCreateModal(); openCreateModal(); });
  $('btn-close-modal').addEventListener('click', closeCreateModal);
  $('btn-cancel-create').addEventListener('click', closeCreateModal);
  $('modal-backdrop').addEventListener('click', (e) => { if (e.target === $('modal-backdrop')) closeCreateModal(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeCreateModal(); });

  $('btn-create-release').addEventListener('click', async () => {
    await createRelease();
    const txt = $('r-out').textContent || '';
    if (!txt.startsWith('–û—à–∏–±–∫–∞:')) closeCreateModal();
  });

  // Init
  refresh();
</script>

</body>
</html>
